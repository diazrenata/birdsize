---
title: "ID matching"
author: "Renata Diaz"
date: '2022-06-22'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(birdsize)
library(DBI)

```

Iterate over tables in MATSS to get species_tables
```{r, eval = F}
#
# matssdatafiles <- list.files("../../Datasets/breed-bird-survey-prepped/", full.names = T, pattern = ".RDS")
#
# sptables <- list()
#
# for(i in 1:length(matssdatafiles)) {
#
#   this_matss <- readRDS(matssdatafiles[i])
#   sptables[[i]] <- this_matss$metadata$species_table
# }
#
# all_sptables <- bind_rows(sptables) %>%
#   distinct()
#
# colnames(all_sptables)

# saveRDS(all_sptables, file = here::here("species_fix", "all_MATSS_species.rds"))
```

```{r}
all_MATSS_species <- readRDS(file =here::here("species_fix", "all_MATSS_species.RDS"))

raw_masses <- raw_masses

colnames(all_MATSS_species)
colnames(raw_masses)

sum(raw_masses$species_id %in% all_MATSS_species$species_id) # raw_masses$species_id == MATSS$species_id

bbs_db <- dbConnect(RSQLite::SQLite(), '../../retriever_data/bbs.sqlite')
species <- dplyr::tbl(bbs_db, "breed_bird_survey_species")

colnames(species)

retriever_ids <- as.data.frame(species)

```

# Compare retriever to MATSS


```{r}
colnames(retriever_ids)
colnames(all_MATSS_species)

length(unique(all_MATSS_species$species_id))
sum(unique(all_MATSS_species$species_id) %in% retriever_ids$species_id) # species_id values overlap but don't all match

species_id_matches <- left_join(all_MATSS_species, retriever_ids, by = c("species_id")) %>%
  mutate(genus_match = genus.x == genus.y,
         sp_match = species.x == species.y,
         common_name_match = english_common_name.x == english_common_name.y)

species_id_matches %>%
  select(genus_match, sp_match, common_name_match) %>%
  mutate(n = 1) %>%
  colSums(na.rm =T)
```

Species IDs overlap but don't key to the same species :scream:

MATSS `id` might be `paste0("sp", aou)`

```{r}

head(all_MATSS_species)
head(retriever_ids)


all_MATSS_species <- all_MATSS_species %>%
  mutate(aou = as.numeric(sub("sp", "", id)))


length(unique(all_MATSS_species$aou))
sum(unique(all_MATSS_species$aou) %in% retriever_ids$aou) # this looks promising

```

```{r}

aou_matches <- left_join(all_MATSS_species, retriever_ids, by = c("aou")) %>%
  mutate(genus_match = genus.x == genus.y,
         sp_match = species.x == species.y,
         common_name_match = english_common_name.x == english_common_name.y) %>%
  group_by_all() %>%
  mutate(all_match = sum(genus_match, sp_match, common_name_match, na.rm = T))

aou_not_match <- filter(aou_matches, all_match < 3)

print(aou_not_match)
```
 
The not-matches are:
- 3 common name mismatches with matching genus and species (and hyphens or "hummingbird" vs "gem")
- 5 genus mismatches with matching species and common name 

```{r}

# So I can fix raw_masses to have an AOU column by joining it with MATSS species IDs.

raw_masses_aou <- left_join(raw_masses, all_MATSS_species) %>%
  select(-french_common_name, -spanish_common_name, -id)
filter(raw_masses_aou, is.na(aou))

```

`raw_masses` doesn't have AOU values for some of the jays, which are included in raw masses as close species/replacements for some name changes. So I think once you clean `raw_masses` everyone will have an AOU.

```{r}

cleaned_masses <- birdsize:::clean_sp_size_data(raw_masses_aou) %>%
  select(-aou)
cleaned_raw_masses <- birdsize:::clean_sp_size_data(raw_masses)

all_equal(cleaned_masses, cleaned_raw_masses)


cleaned_masses <- birdsize:::clean_sp_size_data(raw_masses_aou) 

raw_masses <- raw_masses_aou

```

```{r, eval = T}
usethis::use_data(raw_masses, overwrite = T)
```
